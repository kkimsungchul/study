# rokcy linuxì—ì„œ fail2banìœ¼ë¡œ IP ì˜êµ¬ ì°¨ë‹¨í•˜ê¸°



# ì‚¬ìœ 
	ê°œì¸ ì„œë²„ ë§Œë“¤ì—ˆë”ë‹ˆ ê³µê²©ì´ ë„ˆë¬´ ë§ì´ë“¤ì–´ì˜´
	fail2banìœ¼ë¡œ 10ë¶„ê°„ ì°¨ë‹¨ì •ì±… ë§Œë“¤ê³  í–ˆì§€ë§Œ ê³„ì†ë“¤ì–´ì˜´
	ê·¸ë˜ì„œ ì˜êµ¬ì ìœ¼ë¡œ ì°¨ë‹¨í•  ìƒê°ì„

# ëª©í‘œ
	ì¼ë°˜ì ì¸ ê³µê²©ì€ Fail2Banìœ¼ë¡œ ì²˜ë¦¬ (maxretry=5, bantime=600)
	100íšŒ ì´ìƒ ì‹¤íŒ¨í•œ IPëŠ” firewalldë¡œ ì™„ì „ ì°¨ë‹¨ (--permanent)

# ì»¤ìŠ¤í…€ ì•¡ì…˜ íŒŒì¼ ì‘ì„± 
	vi /etc/fail2ban/action.d/firewalld-ban.conf
	=====================================================================
	[Definition]
	actionstart =
	actionstop =
	actioncheck =
	actionban = firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="<ip>" reject' && firewall-cmd --reload
	actionunban = firewall-cmd --permanent --remove-rich-rule='rule family="ipv4" source address="<ip>" reject' && firewall-cmd --reload

	[Init]
	=====================================================================

# ì ìš© í™•ì¸

	=====================================================================
	[root@localhost ~]# fail2ban-client status sshd-strong
	Status for the jail: sshd-strong
	|- Filter
	|  |- Currently failed: 0
	|  |- Total failed:     0
	|  `- File list:        /var/log/secure
	`- Actions
	   |- Currently banned: 0
	   |- Total banned:     0
	   `- Banned IP list:
	=====================================================================

# ì´ë©”ì¼ ë°œì†¡ ì„¤ì •
	vi /etc/fail2ban/action.d/firewalld-ban-mail.conf
	=====================================================================
	[Definition]
	actionstart =
	actionstop =
	actioncheck =

	# IP ì°¨ë‹¨ + ì˜ˆìœ ë©”ì¼ ë°œì†¡
	actionban = printf "To: <dest>\nFrom: <sender>\nSubject: [Fail2Ban] <name> banned <ip>\nContent-Type: text/plain; charset=UTF-8\n\nğŸš« Fail2Ban ê²½ê³ \n\nì°¨ë‹¨ëœ IP: <ip>\nì°¨ë‹¨ ì‹œê°„: `date '+%%Y-%%m-%%d %%H:%%M:%%S'`\n\n> ë¡œê·¸íŒŒì¼: <logpath>\nJail: <name>\n\nìì„¸í•œ ë‚´ìš©ì€ ì„œë²„ ë¡œê·¸ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.\n" | /usr/bin/msmtp -t && firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="<ip>" reject' && firewall-cmd --reload

	actionunban = firewall-cmd --permanent --remove-rich-rule='rule family="ipv4" source address="<ip>" reject' && firewall-cmd --reload

	[Init]
	name = Fail2Ban
	sender = kimsc1218@gmail.com
	dest = kimsc1218@gmail.com

	=====================================================================


# ë©”ì¼ ë°œì†¡ì„ ìœ„í•œ jail ì„¤ì • ì¶”ê°€
	vi /etc/fail2ban/jail.d/sshd-strong.conf
	=====================================================================
	[sshd-strong]
	enabled = true
	filter = sshd
	logpath = /var/log/secure
	maxretry = 100
	findtime = 3600
	bantime = -1
	action = firewalld-ban-mail[name=sshd-strong, sender=kimsc1218@gmail.com, destemail=kimsc1218@gmail.com]
	=====================================================================

# fail2ban ì¬ì‹œì‘
	=====================================================================
	systemctl restart fail2ban
	=====================================================================

# 100íšŒ í…ŒìŠ¤íŠ¸ í•´ë³´ê¸°
	=====================================================================
	for i in {1..110}; do
	  echo "Apr  9 02:53:5$i localhost sshd[12345]: Failed password for root from 123.253.91.15 port 55556 ssh2" >> /var/log/secure
	done
	=====================================================================

# ì°¨ë‹¨ í™•ì¸
	=====================================================================
	[root@localhost ~]# fail2ban-client status sshd-strong
	Status for the jail: sshd-strong
	|- Filter
	|  |- Currently failed: 2
	|  |- Total failed:     18
	|  `- File list:        /var/log/secure
	`- Actions
	   |- Currently banned: 0
	   |- Total banned:     0
	   `- Banned IP list:
	=====================================================================

	=====================================================================
	firewall-cmd --list-all
	=====================================================================



# fail2banì—ì„œ ì—¬ëŸ¬ê°œì˜ sshë“±ë¡í•˜ë©´ ì•ˆë¨
	ë‹¤í–ˆëŠ”ë°, ì•ˆë˜ì„œ ê·¸ëƒ¥ ë¹„í™œì„±í™”í•¨
	vi /etc/fail2ban/jail.d/sshd-strong.conf
	=====================================================================
	enabled = false
	=====================================================================


---
# sshd jail ì„¤ì •ì—ì„œ ì¡°ê±´ ì¶”ê°€

	- ê¸°ë³¸ì ìœ¼ë¡œ jail.conf íŒŒì¼ë‚´ì— sshd-strong ì´ë¼ëŠ” jailì€ ì—†ìŒ
	- ì»¤ìŠ¤í…€ jailì´ë©°, í•´ë‹¹ ë‚´ìš©ìœ¼ë¡œ ì°¨ë‹¨í• ê²ƒì„

	vi /etc/fail2ban/jail.conf
	=====================================================================
	[sshd-strong]
	enabled = true
	filter = sshd
	logpath = /var/log/secure
	maxretry = 100
	bantime = -1         ; ì˜êµ¬ ì°¨ë‹¨
	findtime = 3600      ; 1ì‹œê°„ ì´ë‚´
	action = firewalld-ban[name=sshd-strong]
	=====================================================================

