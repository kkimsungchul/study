# rokcy linux ì—ì„œ fail2banìœ¼ë¡œ ì°¨ë‹¨ëœ IP ë©”ì¼ ë°œì†¡í•˜ê¸°

# ë©”ì¼ ì „ì†¡ ë„êµ¬ ì„¤ì¹˜

	- ì„¤ì¹˜ 
	=====================================================================
	dnf install msmtp -y
	=====================================================================
	
	- í™•ì¸
	=====================================================================
	[root@localhost ~]# msmtp --version
	msmtp version 1.8.10
	Platform: x86_64-redhat-linux-gnu
	TLS/SSL library: GnuTLS
	Authentication library: GNU SASL; oauthbearer: built-in
	Supported authentication methods:
	plain scram-sha-1 external gssapi cram-md5 digest-md5 login ntlm oauthbearer
	IDN support: enabled
	NLS: enabled, LOCALEDIR is /usr/share/locale
	Keyring support: Gnome
	System configuration file name: /etc/msmtprc
	User configuration file name: /root/.msmtprc

	Copyright (C) 2020 Martin Lambers and others.
	This is free software.  You may redistribute copies of it under the terms of
	the GNU General Public License <http://www.gnu.org/licenses/gpl.html>.
	There is NO WARRANTY, to the extent permitted by law.

	=====================================================================

# sendmail ëª…ë ¹ì–´ë¥¼ msmtpë¡œ ì—°ê²°
	Fail2banê³¼ mail ëª…ë ¹ì–´ê°€ ë‚´ë¶€ì ìœ¼ë¡œ sendmailì„ ì“°ë¯€ë¡œ, ì´ë¥¼ msmtpë¡œ ì—°ê²°
	=====================================================================
	ln -sf /usr/bin/msmtp /usr/sbin/sendmail
	=====================================================================

	ê°€ë¦¬í‚¤ëŠ” ê²½ë¡œê°€ /usr/bin/msmtpì—¬ì•¼ í•¨
	=====================================================================
	[root@localhost ~]# which sendmail
	/usr/sbin/sendmail
	=====================================================================

# Gmail SMTP ì„¤ì •

	1. Gmail ê³„ì • ë¡œê·¸ì¸

	2. ë³´ì•ˆ ì„¤ì • > 2ë‹¨ê³„ ì¸ì¦ ì„¤ì •

	3. â€œì•± ë¹„ë°€ë²ˆí˜¸â€ ìƒì„± > ë©”ì¼ / Linux ì»´í“¨í„° ì„ íƒ

	4. ìƒì„±ëœ ë¹„ë°€ë²ˆí˜¸ ì €ì¥í•´ë‘ê¸° (ì˜ˆ: abcd efgh ijkl mnop)

	
# ì„¤ì • íŒŒì¼ ì‘ì„±
	vi /etc/msmtprc
	=====================================================================
	defaults
	auth           on
	tls            on
	tls_trust_file /etc/ssl/certs/ca-bundle.crt
	logfile        /var/log/msmtp.log

	account        gmail
	host           smtp.gmail.com
	port           587
	from           kimsc1218@gmail.com
	user           kimsc1218@gmail.com
	password       ì•±_ë¹„ë°€ë²ˆí˜¸_ì—¬ê¸°ì—_ì…ë ¥

	account default : gmail
	=====================================================================

# ê¶Œí•œ ì„¤ì •

	=====================================================================
	chown root:mail /etc/msmtprc
	chmod 640 /etc/msmtprc
	=====================================================================


# ë©”ì¼ ë°œì†¡ í…ŒìŠ¤íŠ¸
	
	your_email@gmail.com < ë³¸ì¸ë©”ì¼ë¡œ ë³€ê²½
	=====================================================================
	echo "Fail2ban ë©”ì¼ í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤." | mail -s "Fail2ban í…ŒìŠ¤íŠ¸" kimsc1218@gmail.com
	=====================================================================

# ë¡œê·¸ í™•ì¸
	=====================================================================
	tail -f /var/log/msmtp.log
	=====================================================================

# Fail2ban ì•Œë¦¼ ì„¤ì •

	vi /etc/fail2ban/jail.local
	=====================================================================
	[sshd]
	enabled  = true
	port     = ssh
	filter   = sshd
	logpath  = /var/log/secure
	maxretry = 5
	bantime  = 600
	action   = %(action_mwl)s
	destemail = kimsc1218@gmail.com
	sender = kimsc1218@gmail.com
	mta = msmtp
	=====================================================================

	%(action_mwl)sëŠ” ë¡œê·¸ í¬í•¨ , whois ê²°ê³¼ í¬í•¨ , ë©”ì¼ ì „ì†¡




# Fail2ban ì¬ì‹œì‘
	=====================================================================
	systemctl restart fail2ban
	=====================================================================

# ì˜¤ë¥˜ ë°œìƒ
	=====================================================================
	â— fail2ban.service - Fail2Ban Service
	   Loaded: loaded (/usr/lib/systemd/system/fail2ban.service; enabled; vendor preset: disabled)
	   Active: failed (Result: exit-code) since Wed 2025-04-09 01:46:16 KST; 27s ago
		 Docs: man:fail2ban(1)
	  Process: 342115 ExecStop=/usr/bin/fail2ban-client stop (code=exited, status=0/SUCCESS)
	  Process: 342127 ExecStart=/usr/bin/fail2ban-server -xf start (code=exited, status=255)
	  Process: 342125 ExecStartPre=/bin/mkdir -p /run/fail2ban (code=exited, status=0/SUCCESS)
	 Main PID: 342127 (code=exited, status=255)

	 4ì›” 09 01:46:16 localhost.localdomain systemd[1]: Starting Fail2Ban Service...
	 4ì›” 09 01:46:16 localhost.localdomain systemd[1]: Started Fail2Ban Service.
	 4ì›” 09 01:46:16 localhost.localdomain fail2ban-server[342127]: 2025-04-09 01:46:16,589 fail2ban.configreader   [342127]: ERROR   Found no accessible config files for 'action.d/msmtp-whois-lines' under /etc/fail2ban
	 4ì›” 09 01:46:16 localhost.localdomain fail2ban-server[342127]: 2025-04-09 01:46:16,589 fail2ban.jailreader     [342127]: ERROR   Unable to read action 'msmtp-whois-lines'
	 4ì›” 09 01:46:16 localhost.localdomain fail2ban-server[342127]: 2025-04-09 01:46:16,589 fail2ban.jailsreader    [342127]: ERROR   Errors in jail 'sshd'. Skipping...
	 4ì›” 09 01:46:16 localhost.localdomain fail2ban-server[342127]: 2025-04-09 01:46:16,593 fail2ban                [342127]: ERROR   Async configuration of server failed
	 4ì›” 09 01:46:16 localhost.localdomain systemd[1]: fail2ban.service: Main process exited, code=exited, status=255/n/a
	 4ì›” 09 01:46:16 localhost.localdomain systemd[1]: fail2ban.service: Failed with result 'exit-code'.
	=====================================================================

# ì˜¤ë¥˜ í•´ê²°
	í˜„ì¬ ë¬¸ì œëŠ” fail2banì´ ì‹œì‘í•˜ì§€ ëª»í•˜ëŠ” ì´ìœ ëŠ” 
	ì„¤ì •í•œ action = %(action_mwl)s ë‚´ë¶€ì—ì„œ ì‚¬ìš©í•˜ëŠ” msmtp-whois-lines ì•¡ì…˜ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•Šê¸° ë•Œë¬¸
	=====================================================================
	ERROR   Found no accessible config files for 'action.d/msmtp-whois-lines'
	ERROR   Unable to read action 'msmtp-whois-lines'
	=====================================================================
	

	- msmtpìš© ì»¤ìŠ¤í…€ ì•¡ì…˜ ìƒì„±
	vi /etc/fail2ban/action.d/msmtp.conf
	destì— ë³´ë‚´ê³  ì‹¶ì€ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì‘ì„±
	=====================================================================
	[Definition]
	actionstart =
	actionstop =
	actioncheck =
	actionban = printf "To: <dest>\nFrom: <sender>\nSubject: [Fail2Ban] <name> banned <ip>\nContent-Type: text/plain; charset=UTF-8\n\nğŸš« Fail2Ban ê²½ê³ \n\nì°¨ë‹¨ëœ IP: <ip>\nì°¨ë‹¨ ì‹œê°„: `date '+%%Y-%%m-%%d %%H:%%M:%%S'`\nì‹œë„ëœ ê³„ì •: <matches>\n\n>ë¡œê·¸íŒŒì¼: <logpath>\nJail: <name>\n\nìì„¸í•œ ë‚´ìš©ì€ ì„œë²„ ë¡œê·¸ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.\n" | /usr/bin/msmtp -t
	actionunban =

	[Init]
	name = Fail2Ban
	sender = kimsc1218@gmail.com
	dest = kimsc1218@gmail.com
	=====================================================================

	- ì˜µì…˜ ì„¤ëª…
	Subject: [Fail2Ban] <name> banned <ip>: ì œëª© í¬í•¨
	\n\nFail2Ban has banned IP: <ip>...: ë³¸ë¬¸ í¬í•¨
	msmtp -t: í—¤ë”ì™€ ë³¸ë¬¸ì„ ì§ì ‘ êµ¬ì„±í•  ë•Œ í•„ìš”
	--debug: ë©”ì¼ ì „ì†¡ í™•ì¸ìš© ë¡œê·¸ (ë¬¸ì œ ìˆìœ¼ë©´ ì œê±°í•´ë„ ë¨)
	
	- ì„¤ì • ë³€ê²½
	vi /etc/fail2ban/jail.local
	=====================================================================
	enabled = true
	port = ssh
	filter = sshd
	logpath = /var/log/secure
	maxretry = 5
	bantime = 600
	action = msmtp[name=sshd, dest=kimsc1218@gmail.com]
	destemail = kimsc1218@gmail.com
	sender = kimsc1218@gmail.com
	mta = msmtp
	=====================================================================



# í…ŒìŠ¤íŠ¸
	- ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì¹˜ë©´ ë©”ì¼ì´ ì™€ìˆìŒ	
	=====================================================================
	fail2ban-client set sshd banip 1.2.3.55
	=====================================================================
