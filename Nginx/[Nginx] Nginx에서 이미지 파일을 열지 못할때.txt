# Nginx - Nginxì—ì„œ ì´ë¯¸ì§€ íŒŒì¼ì„ ì—´ì§€ ëª»í• ë•Œ

# ì¦ìƒ
	Nginxì— ì‘ì„±í•œ htmlíŒŒì¼ì—ì„œ imageíŒŒì¼ì„ ì½ì§€ ëª»í•˜ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí•¨
	ê°™ì€ ê²½ë¡œë‚´ì— ìˆëŠ” 1.jpg , 2.jpg , 3.jpgëŠ” ì˜ ì½ëŠ”ë° 
	ìƒˆë¡œ ì¶”ê°€í•œ KMJ_0003.jpg íŒŒì¼ë“¤ì€ ëª»ì½ì–´ì˜´
	=====================================================================
	-rwxr-xr-x. 1 nginx nginx  476387  3ì›” 28 00:24 1.jpg
	-rwxr-xr-x. 1 nginx nginx 2279904  3ì›” 28 00:24 2.jpg
	-rwxr-xr-x. 1 nginx nginx 2192395  3ì›” 28 00:24 3.jpg
	-rwxr-xr-x. 1 nginx nginx 7622913  5ì›” 15 00:45 KMJ_0003.jpg
	-rwxr-xr-x. 1 nginx nginx 7658540  5ì›” 15 00:45 KMJ_0009.jpg	
	=====================================================================

# ì˜¤ë¥˜ ë¡œê·¸
	vi /var/log/nginx/error.log
	=====================================================================
   3032 2025/05/15 00:51:45 [error] 580357#0: *1 open() "/usr/share/nginx/html/image/KMJ_0003.jpg" failed (13: Permission denied), client: 192.168.55.184, server: _, request: "GET /image/KMJ_0003.j        pg HTTP/1.1", host: "192.168.55.125"
   3033 2025/05/15 00:52:26 [error] 580357#0: *1 open() "/usr/share/nginx/html/image/KMJ_0003.jpg" failed (13: Permission denied), client: 192.168.55.184, server: _, request: "GET /image/KMJ_0003.j        pg HTTP/1.1", host: "192.168.55.125"
	=====================================================================

# ì›ì¸
	Rocky linux ì˜ SELinux ê°€ í™œì„±í™” ë˜ì–´ìˆìœ¼ë©´ ë°œìƒí•¨
	=====================================================================
	[root@localhost image]# ls -Z /usr/share/nginx/html/image/KMJ_0003.jpg
	unconfined_u:object_r:user_home_t:s0 /usr/share/nginx/html/image/KMJ_0003.jpg
	=====================================================================

	SELinux contextê°€ ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì •ë˜ì–´ ìˆëŠ” ê²ƒì´ ë¬¸ì œì˜ ì§ì ‘ì ì¸ ì›ì¸
	user_home_tëŠ” ì‚¬ìš©ì í™ˆ ë””ë ‰í† ë¦¬ì— ì“°ì´ëŠ” íƒ€ì…ìœ¼ë¡œ, 
	Nginxê°€ ì´ íƒ€ì…ì˜ íŒŒì¼ì—ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì ‘ê·¼í•  ìˆ˜ ì—†ìŒ. 
	ë”°ë¼ì„œ (13: Permission denied) ì—ëŸ¬ê°€ ë°œìƒ
	=====================================================================
	user_home_t
	=====================================================================

# ì¡°ì¹˜
	Nginx ê°€ ì½ì„ ìˆ˜ ìˆë„ë¡ ë³€ê²½
	=====================================================================
	sudo chcon -R -t httpd_sys_content_t /usr/share/nginx/html/image
	=====================================================================

# ì˜êµ¬ ì¡°ì¹˜
	ì¬ë¶€íŒ… í›„ì—ë„ ì ìš©ë˜ë„ë¡ ì„¤ì •
	=====================================================================
	sudo semanage fcontext -a -t httpd_sys_content_t "/usr/share/nginx/html/image(/.*)?"
	sudo restorecon -Rv /usr/share/nginx/html/image
	=====================================================================

	í˜¹ì‹œë‚˜ semanage ëª…ë ¹ì–´ê°€ ì•ˆë˜ë©´ ì•„ë˜ ì„¤ì¹˜
	=====================================================================
	sudo dnf install policycoreutils-python-utils
	=====================================================================


# ê·¼ë³¸ ì›ì¸
	1. sungchul ê³„ì •ìœ¼ë¡œ SFTPì ‘ì†
	2. ì´ë¯¸ì§€ ë˜ëŠ” htmlíŒŒì¼ì„ sungchul ê³„ì •ì˜ í™ˆ ë””ë ‰í† ë¦¬ì— ë³µì‚¬
	3. root ë¡œ ssh ì ‘ì†
	4. root ë¡œ sungchul í™ˆ ë””ë ‰í† ë¦¬ì— ìˆëŠ” íŒŒì¼ë“¤ì„ mv ëª…ë ¹ì–´ë¡œ ì´ë™

	â€» sungchul ì‚¬ìš©ì í™ˆ ë””ë ‰í† ë¦¬ì— ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ëŠ” ìë™ìœ¼ë¡œ SELinux context user_home_t ë¥¼ ê°€ì§€ê²Œë¨
	ìœ„ ë‚´ìš©ì´ ë¬¸ì œì˜ í•µì‹¬
	ì´ì „ì—ëŠ” ë§¤ë²ˆ CPë¡œ í–ˆì—ˆëŠ”ë°, ì´ë²ˆì—ëŠ” ì˜®ê²¨ì•¼ í•  ìš©ëŸ‰ì´ 6GBì´ë‹¤ë³´ë‹ˆ cp ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  mv ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ì„œ ë°œìƒí–ˆìŒ
	
	mvëŠ” SELinux contextë¥¼ ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜¤ê³ 
	cpëŠ” ê¸°ë³¸ì ìœ¼ë¡œ SELinux contextë¥¼ ìƒˆë¡œ ì„¤ì •


	cp (ê¸°ë³¸ ì‚¬ìš©) : ëŒ€ìƒ ë””ë ‰í† ë¦¬ ê¸°ì¤€ìœ¼ë¡œ ìƒˆë¡œ ì„¤ì •ë¨
	mv : ì›ë˜ context ìœ ì§€ë¨	
	cp --preserve=context : ì›ë˜ context ìœ ì§€ë¨
	mv í›„ restorecon ë˜ëŠ” chcon : context ìˆ˜ë™ ì¬ì„¤ì •

	mvë¡œ ê¼­ ì‚¬ìš©í•˜ë ¤ë©´ ì•„ë˜ì²˜ëŸ¼ ëª…ë ¹ì–´ ì…ë ¥
	=====================================================================
	mv ~/file.jpg /usr/share/nginx/html/image/ restorecon /usr/share/nginx/html/image/file.jpg
	=====================================================================

# GPT ë‹µë³€ ë‚´ìš©
	ChatGPTì˜ ë§:
	ë„¤, ì •í™•íˆ ë³´ì…¨ìŠµë‹ˆë‹¤. ì´ë²ˆ ì˜¤ë¥˜ì˜ ê·¼ë³¸ ì›ì¸ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

	ğŸ¯ ê·¼ë³¸ ì›ì¸: SELinux context ëˆ„ì  ë¬¸ì œ
		1. sungchul ì‚¬ìš©ìì˜ í™ˆ ë””ë ‰í† ë¦¬ (/home/sungchul)ì— ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•¨
		2. ê·¸ ì´ë¯¸ì§€ë“¤ì€ ìë™ìœ¼ë¡œ SELinux context user_home_të¥¼ ê°€ì§ â† ë¬¸ì œì˜ í•µì‹¬
		3. ì´í›„ rootë¡œ í•´ë‹¹ íŒŒì¼ì„ /usr/share/nginx/html/image/ ì•„ë˜ë¡œ mv í•˜ê±°ë‚˜ cp í•¨
		4. ê¸°ì¡´ì˜ SELinux context (user_home_t)ê°€ ê·¸ëŒ€ë¡œ ë”°ë¼ì˜´
		5. NginxëŠ” user_home_t íƒ€ì… íŒŒì¼ì—ëŠ” ì ‘ê·¼í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ Permission denied ë°œìƒ

	âš ï¸ SELinuxëŠ” íŒŒì¼ì˜ "ë§¥ë½(context)"ë„ ì˜®ê²¨ì˜´
		mvë¥¼ í•˜ë©´ ì¼ë°˜ì ìœ¼ë¡œ:
		íŒŒì¼ ê¶Œí•œ (chmod)
		ì†Œìœ ì (chown)
	
	âœ… ê·¸ë¦¬ê³  SELinux contextë„ ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤
		ê·¸ë˜ì„œ mví•œ íŒŒì¼ë„ ì—¬ì „íˆ user_home_tì¸ ê²ƒì´ì£ .

	âœ… ì˜¬ë°”ë¥¸ ì²˜ë¦¬ ë°©ë²•
	1. mv ë˜ëŠ” cp í›„ contextë¥¼ ì¬ì„¤ì •í•´ì•¼ í•¨
	=====================================================================
	sudo restorecon -v /usr/share/nginx/html/image/KMJ_0003.jpg
	=====================================================================
	ë˜ëŠ” ë””ë ‰í† ë¦¬ ì „ì²´:

	=====================================================================
	sudo restorecon -Rv /usr/share/nginx/html/image
	=====================================================================
	ì´ ëª…ë ¹ì€ í•´ë‹¹ ê²½ë¡œì˜ ê¸°ë³¸ ì •ì±…ì— ë§ëŠ” SELinux contextë¡œ ìë™ ì¬ì„¤ì •í•´ì¤ë‹ˆë‹¤.

	âœ… ì˜ˆë°© íŒ
	ìƒí™©	ê¶Œì¥ ë°©ë²•
	í™ˆ ë””ë ‰í† ë¦¬ì—ì„œ ê°€ì ¸ì˜¨ íŒŒì¼ì´ ìˆì„ ë•Œ	restorecon ë˜ëŠ” chcon ìœ¼ë¡œ context ì¬ì„¤ì •
	ìì£¼ ì˜®ê²¨ì•¼ í•  ê²½ìš°	cp --preserve=all ëŒ€ì‹  cpë§Œ ì“°ê³  restorecon
	ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš© ì‹œ	íŒŒì¼ ë³µì‚¬ í›„ restorecon í¬í•¨ì‹œí‚¤ê¸°

	ğŸ“ ìš”ì•½
	ğŸ”¥ ë¬¸ì œ ì›ì¸: í™ˆ ë””ë ‰í† ë¦¬ì—ì„œ ì˜¨ íŒŒì¼ì´ SELinux context user_home_të¥¼ ìœ ì§€

	âŒ NginxëŠ” ì´ context íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŒ

	âœ… í•´ê²°: chcon ë˜ëŠ” restoreconìœ¼ë¡œ contextë¥¼ httpd_sys_content_të¡œ ë³€ê²½
